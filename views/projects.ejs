<%- include('partials/header') %>
<%- include('partials/admin-styles') %>
<main class="admin-container">
  <% const categories = items ? [...new Set(items.map(item => item.category).filter(Boolean))] : []; %>

  <% if (admin) { %>
  <div class="admin-header">
    <h1>Project Gallery</h1>
    <div class="admin-actions">
      <a class="btn-secondary" href="/admin">← Dashboard</a>
      <a class="btn-admin" href="/admin/gallery/new"><i class="fas fa-plus"></i> Add New Project</a>
    </div>
  </div>

  <!-- Stats Overview (minimal) -->
  <div class="stats-overview">
    <div class="stat-card">
      <div class="stat-number"><%= items ? items.length : 0 %></div>
      <div class="stat-label">Total Projects</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">
        <% const withoutImages = items ? items.filter(item => !(item.images && item.images.length)).length : 0; %>
        <%= withoutImages %>
      </div>
      <div class="stat-label">Needs Images</div>
    </div>
  </div>

  <!-- Search and Filter -->
  <div class="admin-filters">
    <div class="search-box">
      <input type="text" placeholder="Search projects..." id="searchInput">
    </div>
    
    <select class="filter-select" id="categoryFilter">
      <option value="">All Categories</option>
      <% if (categories && categories.length) { %>
        <% categories.forEach(cat => { %>
          <option value="<%= cat %>"><%= cat %></option>
        <% }) %>
      <% } %>
    </select>
    
    <select class="filter-select" id="sortSelect">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
      <option value="az">A → Z</option>
      <option value="za">Z → A</option>
    </select>
  </div>

  <!-- Gallery Content -->
  <div class="admin-card">
  <% } else { %>

  <!-- Public hero and grid -->
  <section class="projects-hero">
    <div class="container">
      <div class="breadcrumb">Projects</div>
      <h1>Project Gallery</h1>
      <p class="lead">Explore our recent projects and case studies.</p>
      <div class="hero-cta"><a href="/projects" class="btn btn-secondary btn-projects">View our projects gallery</a></div>
    </div>
  </section>

  <section class="projects-list container">
    <% } %>
    <% if (admin) { %>
    <% if (items && items.length) { %>
      <div class="gallery-list">
        <% items.forEach(function(item) { %>
          <article class="gallery-card" 
                   data-title="<%= item.title.toLowerCase() %>"
                   data-category="<%= item.category || '' %>"
                   data-date="<%= item.createdAt || '' %>" data-images='<%= JSON.stringify(item.images || []) %>'>
            <div class="gallery-card-image">
              <% if (item.images && item.images.length) { %>
                <img src="<%= item.images[0] %>" alt="<%= item.title %>" loading="lazy" />
              <% } else { %>
                <div class="no-image muted">No image</div>
              <% } %>
            </div>
            <div class="gallery-card-body">
              <h3 class="gallery-title"><%= item.title %></h3>
              <div class="gallery-meta">
                <span class="gallery-category"><%= item.category || 'Uncategorized' %></span>
              </div>
              <p class="gallery-caption"><%= item.caption || 'No description provided' %></p>

              <div class="gallery-actions">
                <a class="icon-btn edit" href="/admin/gallery/<%= item._id %>/edit" title="Edit"><i class="fas fa-edit"></i></a>
                <form method="post" action="/admin/gallery/<%= item._id %>/delete" class="delete-form">
                  <button class="icon-btn delete" type="submit" title="Delete"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </div>
          </article>
        <% }) %>
      </div>
    <% } else { %>
      <div class="muted">
        <p>No gallery items yet.</p>
        <a href="/admin/gallery/new" class="btn-admin" style="margin-top: 20px;">
          <i class="fas fa-plus"></i> Add Your First Project
        </a>
      </div>
    <% } %>
  </div>
  <% } else { %>
    <% if (items && items.length) { %>
      <div class="projects-grid">
        <% items.forEach(function(item) { %>
          <article class="project-card" data-images='<%= JSON.stringify(item.images || []) %>'>
            <div class="project-image">
              <% if (item.images && item.images.length) { %>
                <div class="card-carousel" data-images='<%= JSON.stringify(item.images.slice(0,6)) %>'>
                  <button class="carousel-nav prev" aria-label="Previous image"><i class="fas fa-chevron-left"></i></button>
                  <div class="carousel-track">
                    <% item.images.slice(0,6).forEach(function(src, idx){ %>
                      <div class="carousel-slide" data-index="<%= idx %>">
                        <img src="<%= src %>" alt="<%= item.title %> - image <%= idx+1 %>" loading="lazy">
                      </div>
                    <% }) %>
                  </div>
                  <button class="carousel-nav next" aria-label="Next image"><i class="fas fa-chevron-right"></i></button>
                </div>
              <% } else { %>
                <div class="no-image muted">No image</div>
              <% } %>
            </div>
            <div class="project-body">
              <span class="project-badge"><%= item.category || 'Uncategorized' %></span>
              <h3><%= item.title %></h3>
              <p class="muted"><%= item.caption || '' %></p>
            </div>
          </article>
        <% }) %>
      </div>

      <!-- Lightbox Modal (projects page) -->
      <div class="lightbox" id="lightbox" role="dialog" aria-hidden="true" aria-modal="true" aria-label="Project image lightbox">
        <div class="lightbox-content" tabindex="-1">
          <button class="lightbox-close" aria-label="Close lightbox"><i class="fas fa-times"></i></button>
          <div class="lightbox-carousel-wrapper"><!-- dynamic lightbox carousel injected here --></div>
          <div class="lightbox-info"><h3 class="lightbox-title"></h3><p class="lightbox-category"></p></div>
        </div>
      </div>

    <% } else { %>
      <p class="muted">No projects yet. Check back later.</p>
    <% } %>
  <% } %>
  
  <!-- Pagination (Optional) -->
  <% if (items && items.length > 12) { %>
    <div class="pagination">
      <a href="?page=1" class="page-btn">«</a>
      <a href="?page=1" class="page-btn active">1</a>
      <a href="?page=2" class="page-btn">2</a>
      <a href="?page=3" class="page-btn">3</a>
      <span class="page-btn disabled">...</span>
      <a href="?page=5" class="page-btn">5</a>
      <a href="?page=2" class="page-btn">»</a>
    </div>
  <% } %>
</main>

<%- include('partials/footer') %>

